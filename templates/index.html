<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groundwater Commons Game</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { font-size: 32px; margin-bottom: 10px; color: #60a5fa; }
        .subtitle { color: #94a3b8; margin-bottom: 30px; line-height: 1.6; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #1e293b; }
        .tab { padding: 12px 24px; cursor: pointer; background: none; border: none; color: #94a3b8; font-size: 16px; transition: all 0.2s; }
        .tab.active { color: #60a5fa; border-bottom: 2px solid #60a5fa; margin-bottom: -2px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: #1e293b; border-radius: 12px; padding: 24px; margin-bottom: 20px; border: 1px solid #334155; }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px; font-weight: 500; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: #e2e8f0; font-size: 14px; }
        input[type="range"] { width: 100%; height: 8px; background: #334155; border-radius: 4px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; background: #60a5fa; border-radius: 50%; cursor: pointer; }
        button { padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        button:hover { background: #2563eb; }
        button:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
        button.secondary { background: #475569; }
        button.secondary:hover { background: #64748b; }
        button.danger { background: #dc2626; }
        button.danger:hover { background: #b91c1c; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .metric { background: #0f172a; padding: 16px; border-radius: 8px; border: 1px solid #334155; }
        .metric-label { font-size: 12px; color: #94a3b8; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-value { font-size: 24px; font-weight: 700; color: #60a5fa; font-family: 'Courier New', monospace; }
        .progress-bar { height: 24px; background: #0f172a; border-radius: 8px; overflow: hidden; border: 1px solid #334155; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); transition: width 0.3s; }
        .player-list { margin-top: 16px; }
        .player-item { display: flex; justify-content: space-between; padding: 12px; background: #0f172a; border-radius: 8px; margin-bottom: 8px; border: 1px solid #334155; }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .status-waiting { background: #fbbf24; color: #78350f; }
        .status-submitted { background: #22c55e; color: #14532d; }
        .status-running { background: #3b82f6; color: #1e3a8a; }
        .status-finished { background: #8b5cf6; color: #4c1d95; }
        .status-lobby { background: #64748b; color: #1e293b; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .leaderboard { margin-top: 16px; }
        .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #0f172a; border-radius: 8px; margin-bottom: 8px; border: 1px solid #334155; }
        .rank { font-size: 20px; font-weight: 700; color: #60a5fa; width: 40px; }
        .alert { padding: 16px; border-radius: 8px; margin-bottom: 16px; }
        .alert-info { background: #1e3a8a; color: #93c5fd; border: 1px solid #3b82f6; }
        .alert-success { background: #14532d; color: #86efac; border: 1px solid #22c55e; }
        .alert-error { background: #7f1d1d; color: #fca5a5; border: 1px solid #dc2626; }
        .code-display { font-family: 'Courier New', monospace; font-size: 32px; font-weight: 700; color: #60a5fa; text-align: center; padding: 20px; background: #0f172a; border-radius: 8px; margin: 20px 0; letter-spacing: 4px; }
        .hidden { display: none; }
        .slider-value { display: inline-block; margin-left: 12px; font-weight: 700; color: #60a5fa; font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>LPPP3559/5559 Groundwater Commons Game</h1>
        <p class="subtitle">You are a farmer pumping groundwater to irrigate your crops. Pumping water lowers the water level, which makes pumping more expensive. The aquifer naturally replenishes at some rate.</p>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('player')">Join as Player</button>
            <button class="tab" onclick="switchTab('host')">Host Controls</button>
        </div>

        <!-- Player Tab -->
        <div id="player-tab" class="tab-content active">
            <div id="player-join-screen">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">Join a Room</h2>
                    <div class="form-group">
                        <label>Room Code</label>
                        <input type="text" id="join-code" placeholder="Enter 5-character code" maxlength="5" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Your Name</label>
                        <input type="text" id="player-name" placeholder="Enter your name">
                    </div>
                    <button onclick="joinRoom()">Join Room</button>
                    <div id="join-error" class="alert alert-error hidden" style="margin-top: 16px;"></div>
                </div>
            </div>

            <div id="player-game-screen" class="hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin-bottom: 4px;">Room: <span id="player-room-code" style="color: #60a5fa;"></span></h2>
                            <p style="color: #94a3b8;">You: <span id="player-display-name"></span> | Well: <span id="player-well"></span></p>
                        </div>
                        <span id="player-status-badge" class="status-badge status-lobby">LOBBY</span>
                    </div>
                </div>

                <div id="player-lobby-screen">
                    <div class="alert alert-info">Waiting for host to start the game...</div>
                </div>

                <div id="player-playing-screen" class="hidden">
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-label">Round</div>
                            <div class="metric-value" id="player-round">0</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">This Round Profit</div>
                            <div class="metric-value" id="player-profit-preview">0</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Cumulative Profit</div>
                            <div class="metric-value" id="player-cumulative">0</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Max Pumping</div>
                            <div class="metric-value" id="player-qmax">80</div>
                        </div>
                    </div>

                    <div class="card">
                        <label>Aquifer Stock</label>
                        <div class="progress-bar">
                            <div id="player-aquifer-bar" class="progress-fill" style="width: 100%;"></div>
                        </div>
                        
                        <label>Choose your pumping rate (q)</label>
                        <input type="range" id="player-q-slider" min="0" max="80" value="40" step="1" oninput="updatePlayerProfit()">
                        <span class="slider-value" id="player-q-display">40</span>
                        
                        <div style="margin-top: 20px;">
                            <button id="player-submit-btn" onclick="submitPumping()">Finalize Pumping Decision</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 12px; color: #60a5fa;">Player Status</h3>
                        <div id="player-list" class="player-list"></div>
                    </div>
                </div>

                <div id="player-finished-screen" class="hidden">
                    <div class="alert alert-success">Game finished! Final results below.</div>
                    <div class="card">
                        <h3 style="margin-bottom: 16px; color: #60a5fa;">Final Leaderboard</h3>
                        <div id="player-final-leaderboard"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Host Tab -->
        <div id="host-tab" class="tab-content">
            <div id="host-create-screen">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">Create New Room</h2>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Price (P)</label>
                            <input type="number" id="param-P" value="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Gamma (γ)</label>
                            <input type="number" id="param-gamma" value="0.5" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Base Cost (c₀)</label>
                            <input type="number" id="param-c0" value="5" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Depth Cost (c₁)</label>
                            <input type="number" id="param-c1" value="0.006" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>Initial Stock (S₀)</label>
                            <input type="number" id="param-S0" value="1000" step="10">
                        </div>
                        <div class="form-group">
                            <label>Max Stock (Smax)</label>
                            <input type="number" id="param-Smax" value="1000" step="10">
                        </div>
                        <div class="form-group">
                            <label>Recharge Rate (R)</label>
                            <input type="number" id="param-R" value="50" step="1">
                        </div>
                        <div class="form-group">
                            <label>Max Pumping (qmax)</label>
                            <input type="number" id="param-qmax" value="80" step="1">
                        </div>
                        <div class="form-group">
                            <label>Number of Rounds (T)</label>
                            <input type="number" id="param-T" value="8" step="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>Players per Room</label>
                            <input type="number" id="param-players" value="6" step="1" min="3" max="7">
                        </div>
                    </div>
                    <button onclick="createRoom()">Create Room</button>
                </div>
            </div>

            <div id="host-manage-screen" class="hidden">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">Room Code</h2>
                    <div class="code-display" id="host-room-code"></div>
                    <p style="text-align: center; color: #94a3b8; margin-bottom: 20px;">Share this code with your students</p>
                </div>

                <div class="metrics">
                    <div class="metric">
                        <div class="metric-label">Status</div>
                        <div class="metric-value" id="host-status" style="font-size: 18px;">LOBBY</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Current Round</div>
                        <div class="metric-value" id="host-round">0</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Players Joined</div>
                        <div class="metric-value" id="host-players-count">0/6</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Aquifer Stock</div>
                        <div class="metric-value" id="host-aquifer-s">1000</div>
                    </div>
                </div>

                <div class="card">
                    <div class="progress-bar">
                        <div id="host-aquifer-bar" class="progress-fill" style="width: 100%;"></div>
                    </div>
                </div>

                <div id="host-lobby-controls" class="card">
                    <h3 style="margin-bottom: 16px; color: #60a5fa;">Players in Lobby</h3>
                    <div id="host-lobby-list" class="player-list"></div>
                    <button id="host-start-btn" onclick="startGame()">Start Game</button>
                </div>

                <div id="host-running-controls" class="card hidden">
                    <h3 style="margin-bottom: 16px; color: #60a5fa;">Submission Status</h3>
                    <div id="host-running-list" class="player-list"></div>
                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <button class="secondary" onclick="forceAdvance()">Force Advance (Host Override)</button>
                        <button class="danger" onclick="endGame()">End Game Now</button>
                    </div>
                </div>

                <div id="host-finished-controls" class="card hidden">
                    <div class="alert alert-success">Game finished!</div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 16px; color: #60a5fa;">Leaderboard</h3>
                    <div id="host-leaderboard" class="leaderboard"></div>
                </div>

                <button class="secondary" onclick="resetHost()">Create New Room</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentRoom = null;
        let playerState = null;
        let isUserSliding = false;
        let lastRoundSeen = 0;

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        async function joinRoom() {
            const code = document.getElementById('join-code').value.toUpperCase().trim();
            const name = document.getElementById('player-name').value.trim();
            
            if (!code || !name) {
                showError('join-error', 'Please enter both room code and name');
                return;
            }

            try {
                const response = await fetch('/api/join_room', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code, name})
                });

                const data = await response.json();
                if (response.ok) {
                    currentRoom = code;
                    playerState = data;
                    document.getElementById('player-join-screen').classList.add('hidden');
                    document.getElementById('player-game-screen').classList.remove('hidden');
                    document.getElementById('player-room-code').textContent = code;
                    document.getElementById('player-display-name').textContent = name;
                    document.getElementById('player-well').textContent = data.well_index + 1;
                    
                    socket.emit('join', {code});
                    pollGameState();
                } else {
                    showError('join-error', data.error);
                }
            } catch (error) {
                showError('join-error', 'Connection error. Please try again.');
            }
        }

        async function pollGameState() {
            if (!currentRoom) return;
            
            try {
                const response = await fetch(`/api/room_state?code=${currentRoom}`);
                const data = await response.json();
                
                updatePlayerUI(data);
                
                if (data.status === 'running' || data.status === 'lobby') {
                    setTimeout(pollGameState, 2000);
                }
            } catch (error) {
                console.error('Failed to poll game state:', error);
                setTimeout(pollGameState, 2000);
            }
        }

        function updatePlayerUI(data) {
            const badge = document.getElementById('player-status-badge');
            badge.textContent = data.status.toUpperCase();
            badge.className = `status-badge status-${data.status}`;

            if (data.status === 'lobby') {
                document.getElementById('player-lobby-screen').classList.remove('hidden');
                document.getElementById('player-playing-screen').classList.add('hidden');
                document.getElementById('player-finished-screen').classList.add('hidden');
            } else if (data.status === 'running') {
                document.getElementById('player-lobby-screen').classList.add('hidden');
                document.getElementById('player-playing-screen').classList.remove('hidden');
                document.getElementById('player-finished-screen').classList.add('hidden');

                document.getElementById('player-round').textContent = data.current_round;
                document.getElementById('player-cumulative').textContent = Math.round(data.my_cumulative);
                document.getElementById('player-qmax').textContent = data.qmax;

                const pct = (data.S / data.Smax) * 100;
                document.getElementById('player-aquifer-bar').style.width = pct + '%';

                const slider = document.getElementById('player-q-slider');
                // attach once
                if (!slider._handlersBound) {
                const startDrag = () => { isUserSliding = true; };
                const endDrag = () => { isUserSliding = false; };
                slider.addEventListener('mousedown', startDrag);
                slider.addEventListener('touchstart', startDrag, {passive:true});
                slider.addEventListener('mouseup', endDrag);
                slider.addEventListener('touchend', endDrag);
                slider.addEventListener('blur', endDrag);
                slider._handlersBound = true;
                }

slider.max = data.qmax;

// If the round advanced, clear drag state (so the server may set a fresh value if it has one)
if (data.current_round !== lastRoundSeen) {
  isUserSliding = false;
  lastRoundSeen = data.current_round;
}

if (!data.my_submitted) {
  slider.disabled = false;
  document.getElementById('player-submit-btn').disabled = false;

  // Only let the server set the slider IF:
  // 1) the server actually has a saved value for me, and
  // 2) I am not actively dragging right now, and
  // 3) the input isn't focused
  if (data.my_has_act && !isUserSliding && document.activeElement !== slider) {
    slider.value = data.my_q;
  }
} else {
  slider.disabled = true;
  document.getElementById('player-submit-btn').disabled = true;
}

document.getElementById('player-q-display').textContent = slider.value;


                updatePlayerProfit();
                updatePlayerList(data.players);
            } else if (data.status === 'finished') {
                document.getElementById('player-lobby-screen').classList.add('hidden');
                document.getElementById('player-playing-screen').classList.add('hidden');
                document.getElementById('player-finished-screen').classList.remove('hidden');

                const sorted = data.players.sort((a, b) => b.cumulative_profit - a.cumulative_profit);
                const html = sorted.map((p, i) => `
                    <div class="leaderboard-item">
                        <span class="rank">#${i+1}</span>
                        <span>${p.name} (Well ${p.well})</span>
                        <span style="font-weight: 700; color: #60a5fa;">${Math.round(p.cumulative_profit)}</span>
                    </div>
                `).join('');
                document.getElementById('player-final-leaderboard').innerHTML = html;
            }
        }

        function updatePlayerProfit() {
            const q = parseFloat(document.getElementById('player-q-slider').value);
            document.getElementById('player-q-display').textContent = q;
        }

        function updatePlayerList(players) {
            const html = players.map(p => `
                <div class="player-item">
                    <span>${p.name} (Well ${p.well})</span>
                    <span class="status-badge ${p.submitted ? 'status-submitted' : 'status-waiting'}">
                        ${p.submitted ? '✓ Submitted' : '⏳ Waiting'}
                    </span>
                </div>
            `).join('');
            document.getElementById('player-list').innerHTML = html;
        }

        async function submitPumping() {
            const q = parseFloat(document.getElementById('player-q-slider').value);
            
            try {
                const response = await fetch('/api/submit_action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code: currentRoom, q})
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('player-profit-preview').textContent = Math.round(data.profit);
                    document.getElementById('player-submit-btn').disabled = true;
                    document.getElementById('player-q-slider').disabled = true;
                    pollGameState();
                }
            } catch (error) {
                console.error('Failed to submit action:', error);
            }
        }

        async function createRoom() {
            const params = {
                P: parseFloat(document.getElementById('param-P').value),
                gamma: parseFloat(document.getElementById('param-gamma').value),
                c0: parseFloat(document.getElementById('param-c0').value),
                c1: parseFloat(document.getElementById('param-c1').value),
                S0: parseFloat(document.getElementById('param-S0').value),
                Smax: parseFloat(document.getElementById('param-Smax').value),
                R: parseFloat(document.getElementById('param-R').value),
                qmax: parseFloat(document.getElementById('param-qmax').value),
                T: parseInt(document.getElementById('param-T').value),
                players_expected: parseInt(document.getElementById('param-players').value)
            };

            try {
                const response = await fetch('/api/create_room', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });

                const data = await response.json();
                currentRoom = data.code;
                document.getElementById('host-room-code').textContent = data.code;
                document.getElementById('host-create-screen').classList.add('hidden');
                document.getElementById('host-manage-screen').classList.remove('hidden');
                
                socket.emit('join', {code: data.code});
                pollHostState();
            } catch (error) {
                alert('Failed to create room');
            }
        }

        async function pollHostState() {
            if (!currentRoom) return;
            
            try {
                const response = await fetch(`/api/room_state?code=${currentRoom}`);
                const data = await response.json();
                
                updateHostUI(data);
                setTimeout(pollHostState, 2000);
            } catch (error) {
                console.error('Failed to poll host state:', error);
                setTimeout(pollHostState, 2000);
            }
        }

        function updateHostUI(data) {
            document.getElementById('host-status').textContent = data.status.toUpperCase();
            document.getElementById('host-round').textContent = data.current_round;
            document.getElementById('host-players-count').textContent = `${data.players.length}/${data.params.players_expected}`;
            document.getElementById('host-aquifer-s').textContent = Math.round(data.S);

            const pct = (data.S / data.Smax) * 100;
            document.getElementById('host-aquifer-bar').style.width = pct + '%';

            if (data.status === 'lobby') {
                document.getElementById('host-lobby-controls').classList.remove('hidden');
                document.getElementById('host-running-controls').classList.add('hidden');
                document.getElementById('host-finished-controls').classList.add('hidden');

                const html = data.players.map(p => `
                    <div class="player-item">
                        <span>${p.name}</span>
                        <span>Well ${p.well}</span>
                    </div>
                `).join('');
                document.getElementById('host-lobby-list').innerHTML = html;
                document.getElementById('host-start-btn').disabled = data.players.length === 0;
            } else if (data.status === 'running') {
                document.getElementById('host-lobby-controls').classList.add('hidden');
                document.getElementById('host-running-controls').classList.remove('hidden');
                document.getElementById('host-finished-controls').classList.add('hidden');

                const html = data.players.map(p => `
                    <div class="player-item">
                        <span>${p.name} (Well ${p.well})</span>
                        <span class="status-badge ${p.submitted ? 'status-submitted' : 'status-waiting'}">
                            ${p.submitted ? '✓ Submitted' : '⏳ Waiting'}
                        </span>
                    </div>
                `).join('');
                document.getElementById('host-running-list').innerHTML = html;
            } else if (data.status === 'finished') {
                document.getElementById('host-lobby-controls').classList.add('hidden');
                document.getElementById('host-running-controls').classList.add('hidden');
                document.getElementById('host-finished-controls').classList.remove('hidden');
            }

            const sorted = data.players.sort((a, b) => b.cumulative_profit - a.cumulative_profit);
            const leaderHtml = sorted.map((p, i) => `
                <div class="leaderboard-item">
                    <span class="rank">#${i+1}</span>
                    <span>${p.name} (Well ${p.well})</span>
                    <span style="font-weight: 700; color: #60a5fa;">${Math.round(p.cumulative_profit)}</span>
                </div>
            `).join('');
            document.getElementById('host-leaderboard').innerHTML = leaderHtml;
        }

        async function startGame() {
            try {
                await fetch('/api/start_game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code: currentRoom})
                });
                pollHostState();
            } catch (error) {
                alert('Failed to start game');
            }
        }

        async function forceAdvance() {
            try {
                await fetch('/api/force_advance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code: currentRoom})
                });
                pollHostState();
            } catch (error) {
                alert('Failed to force advance');
            }
        }

        async function endGame() {
            if (!confirm('Are you sure you want to end the game now?')) return;
            
            try {
                await fetch('/api/end_game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code: currentRoom})
                });
                pollHostState();
            } catch (error) {
                alert('Failed to end game');
            }
        }

        function resetHost() {
            currentRoom = null;
            document.getElementById('host-create-screen').classList.remove('hidden');
            document.getElementById('host-manage-screen').classList.add('hidden');
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        socket.on('game_started', () => {
            pollGameState();
            pollHostState();
        });

        socket.on('round_advanced', () => {
            pollGameState();
            pollHostState();
        });

        socket.on('player_submitted', () => {
            pollGameState();
            pollHostState();
        });

        socket.on('game_ended', () => {
            pollGameState();
            pollHostState();
        });
    </script>
</body>
</html>
