<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Groundwater Commons — Solo</title>
  <!-- Style mirrors index.html -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { font-size: 32px; margin-bottom: 10px; color: #60a5fa; }
    .subtitle { color: #94a3b8; margin-bottom: 24px; line-height: 1.6; }
    a { color: #93c5fd; }
    .nav-links { margin-bottom: 20px; }
    .nav-link { display: inline-block; color: #93c5fd; text-decoration: none; margin-right: 15px; padding: 6px 12px; border: 1px solid #334155; border-radius: 6px; font-size: 14px; transition: all 0.2s; }
    .nav-link:hover { border-color: #60a5fa; background: #1e293b; }
    .card { background: #1e293b; border-radius: 12px; padding: 24px; margin-bottom: 20px; border: 1px solid #334155; }
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .metric { background: #0f172a; padding: 16px; border-radius: 8px; border: 1px solid #334155; }
    .metric-label { font-size: 12px; color: #94a3b8; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .metric-value { font-size: 24px; font-weight: 700; color: #60a5fa; font-family: 'Courier New', monospace; }
    .progress-bar { height: 24px; background: #0f172a; border-radius: 8px; overflow: hidden; border: 1px solid #334155; margin-bottom: 8px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); transition: width 0.3s; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { margin-bottom: 12px; }
    label { display: block; margin-bottom: 6px; color: #94a3b8; font-size: 14px; font-weight: 500; }
    input[type="number"] { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: #e2e8f0; font-size: 14px; }
    input[type="range"] { width: 100%; height: 8px; background: #334155; border-radius: 4px; outline: none; }
    input[type="range"]::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; background: #60a5fa; border-radius: 50%; cursor: pointer; }
    button { padding: 12px 20px; background: #3b82f6; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: 0.2s; }
    button:hover { background: #2563eb; }
    button:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
    button.secondary { background: #475569; }
    button.secondary:hover { background: #64748b; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .slider-value { display: inline-block; margin-left: 12px; font-weight: 700; color: #60a5fa; font-family: 'Courier New', monospace; }
    .muted { color: #94a3b8; }
    .spacer { height: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav-links">
      <a href="/" class="nav-link">← Home</a>
      <a href="/group" class="nav-link">Group Mode</a>
      <a href="/about" class="nav-link">About</a>
    </div>
    <h1>Solo Aquifer</h1>
    <p class="subtitle">
    You are a farmer pumping groundwater to irrigate your crops. You control all <span id="wells-label">—</span> wells in a single
    groundwater aquifer. Each round, choose how much water to pump from each well.
    Pumping water lowers the water level, and the lower the water level, the more expensive it is to pump. The aquifer naturally replenishes at some rate. Try out different pumping choices and observe how the aquifer behaves over time.
    </p>

    <!-- Top metrics -->
    <div class="metrics">
      <div class="metric"><div class="metric-label">Round</div><div class="metric-value" id="m-round">—</div></div>
      <div class="metric"><div class="metric-label">Stock S</div><div class="metric-value" id="m-s">—</div></div>
      <div class="metric"><div class="metric-label">Smax</div><div class="metric-value" id="m-smax">—</div></div>
      <div class="metric"><div class="metric-label">Wells Owned</div><div class="metric-value" id="m-wells">—</div></div>
      <div class="metric"><div class="metric-label">q per well</div><div class="metric-value" id="m-q">—</div></div>
      <div class="metric"><div class="metric-label">Total Q</div><div class="metric-value" id="m-Q">—</div></div>
      <div class="metric"><div class="metric-label">Cumulative Profit</div><div class="metric-value" id="m-cum">—</div></div>
      <div class="metric"><div class="metric-label">Last Round Profit</div><div class="metric-value" id="m-last">—</div></div>
    </div>

    <!-- Aquifer stock bar + slider -->
    <div class="card">
      <label>Aquifer Stock</label>
      <div class="progress-bar"><div id="aquifer-bar" class="progress-fill" style="width: 100%;"></div></div>
      <div class="spacer"></div>

      <label>Choose per-well pumping (q)</label>
      <div class="row">
        <input id="q" type="range" min="0" max="80" value="40" step="1"/>
        <span class="slider-value">q = <span id="q-val">40</span></span>
        <button id="submit">Submit</button>
        <button id="next" class="secondary">Next round</button>
      </div>
    </div>

    <!-- Parameters (for quick restarts) -->
    <div class="card">
      <h3 style="margin-bottom: 12px; color:#60a5fa;">Parameters</h3>
      <div class="grid-2">
        <div class="form-group"><label>Price (P)</label><input id="P" type="number" step="1" value="10"></div>
        <div class="form-group"><label>Gamma (γ)</label><input id="gamma" type="number" step="0.1" value="0.08"></div>
        <div class="form-group"><label>Base Cost (c₀)</label><input id="c0" type="number" step="0.5" value="2"></div>
        <div class="form-group"><label>Depth Cost (c₁)</label><input id="c1" type="number" step="0.001" value="0.006"></div>
        <div class="form-group"><label>Initial Stock (S₀)</label><input id="S0" type="number" step="10" value="1200"></div>
        <div class="form-group"><label>Max Stock (Smax)</label><input id="Smax" type="number" step="10" value="1200"></div>
        <div class="form-group"><label>Recharge (R)</label><input id="R" type="number" step="1" value="60"></div>
        <div class="form-group"><label>Max Pumping (qmax)</label><input id="qmax" type="number" step="1" value="80"></div>
        <div class="form-group"><label>Rounds (T)</label><input id="T" type="number" step="1" value="8"></div>
        <div class="form-group"><label>Wells</label><input id="wells" type="number" step="1" value="6" min="1" max="24"></div>
      </div>
      <div class="row">
        <button id="start">Start / Restart</button>
        <button id="reset" class="secondary">Reset session</button>
      </div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    // Keep slider UX stable while polling
    let isUserSliding = false;
    let lastRoundSeen = 0;

    // Helpers
    async function post(path, body) {
      const r = await fetch(path, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body||{})
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function get(path) {
      const r = await fetch(path);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function applyState(s) {
      // Metrics
      $('m-round').textContent = s.round;
      $('m-s').textContent = s.S.toFixed(1);
      $('m-smax').textContent = s.Smax.toFixed(0);
      $('m-wells').textContent = s.wells;
      $('wells-label').textContent = s.wells;

      // Stock bar updates every state refresh (fixes “S not updating”)
      const pct = Math.max(0, Math.min(100, (s.S / s.Smax) * 100));
      $('aquifer-bar').style.width = pct + '%';

      // Slider bounds (respect qmax from server)
      const slider = $('q');
      slider.max = s.qmax;

      // Round change resets drag guard so server can set fresh defaults if you want later
      if (s.round !== lastRoundSeen) {
        isUserSliding = false;
        lastRoundSeen = s.round;
      }

      // Derived displays
      $('q-val').textContent = slider.value;
      $('m-q').textContent = slider.value;
      $('m-Q').textContent = (Number(slider.value) * Number(s.wells)).toFixed(1);

      $('m-cum').textContent = s.cumulative_profit.toFixed(1);
      $('m-last').textContent = s.last_profit == null ? '—' : s.last_profit.toFixed(1);

      // Buttons: can submit once per round; next is enabled after submit and while round < T
      $('submit').disabled = !!s.submitted;
      $('next').disabled = !s.submitted || (s.round >= s.T);
    }

    async function refresh() {
      const s = await get('/api/solo/state');
      applyState(s);
    }

    // --- UI wiring ---
    $('q').addEventListener('input', () => {
      $('q-val').textContent = $('q').value;
      $('m-q').textContent = $('q').value;
      $('m-Q').textContent = (Number($('q').value) * Number($('m-wells').textContent)).toFixed(1);
    });
    $('q').addEventListener('mousedown', () => { isUserSliding = true; });
    $('q').addEventListener('touchstart', () => { isUserSliding = true; }, {passive:true});
    ['mouseup','touchend','blur'].forEach(evt => $('q').addEventListener(evt, () => { isUserSliding = false; }));

    $('start').onclick = async () => {
      const body = {
        P: +$('P').value, gamma: +$('gamma').value,
        c0: +$('c0').value, c1: +$('c1').value,
        S0: +$('S0').value, Smax: +$('Smax').value,
        R: +$('R').value, qmax: +$('qmax').value,
        T: +$('T').value, wells: +$('wells').value
      };
      await post('/api/solo/create', body);
      // Clamp current slider to new qmax so UI is consistent
      $('q').value = Math.min(Number($('q').value), body.qmax);
      await refresh();
    };

    $('reset').onclick = async () => { await post('/api/solo/reset', {}); await refresh(); };
    $('submit').onclick = async () => {
      const q = +$('q').value;
      await post('/api/solo/submit', { q });
      // Stock updates server-side; re-fetch to redraw S bar & profits
      await refresh();
    };
    $('next').onclick = async () => {
      await post('/api/solo/next', {});
      await refresh();
    };

    // Gentle polling to keep S in sync even if the student pauses
    setInterval(() => { refresh().catch(()=>{}); }, 2000);

    // Initial load
    refresh().catch(console.error);
  </script>
      <footer style="
    margin-top: 40px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
    font-size: 14px;
    text-align: center;
    color: #666;">
    © 2025 Jenna Anders. All rights reserved.
</footer>
</body>
</html>
